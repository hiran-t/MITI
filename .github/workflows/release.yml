name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    name: Build and Create Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker Image and Export
        run: |
          echo "ðŸ³ Building Docker image..."
          docker build -t miti:${{ github.ref_name }} .
          
          # Save as tar for release
          docker save miti:${{ github.ref_name }} | gzip > miti-docker-${{ github.ref_name }}.tar.gz
          
          echo "âœ… Docker image created"
          ls -lh miti-docker-*.tar.gz
      
      - name: Build application
        run: bun run build
        env:
          NEXT_PUBLIC_ROSBRIDGE_URL: ws://localhost:9090
          STANDALONE_BUILD: true
      
      - name: Create Standalone Package
        run: |
          echo "ðŸ“¦ Creating standalone deployment package..."
          
          # Debug: Check what was built
          echo "Contents of .next/standalone:"
          ls -la .next/standalone/
          echo ""
          echo "Contents of .next/standalone/.next:"
          ls -la .next/standalone/.next/ || echo "No .next in standalone"
          
          # Create the base directory
          mkdir -p deploy/miti
          
          # Copy the entire standalone build INCLUDING hidden files
          cp -r .next/standalone/. deploy/miti/
          
          # IMPORTANT: Next.js standalone build already has .next/ directory
          # We need to add static files to the EXISTING .next/ directory
          echo ""
          echo "Copying static files..."
          cp -r .next/static deploy/miti/.next/
          
          # Copy public files (if standalone didn't include them)
          if [ -d "public" ]; then
            echo "Copying public files..."
            cp -r public deploy/miti/ || true
          fi
          
          # Debug: Verify structure
          echo ""
          echo "Final structure in deploy/miti:"
          ls -la deploy/miti/
          echo ""
          echo "Contents of deploy/miti/.next:"
          ls -la deploy/miti/.next/ || echo "ERROR: No .next directory!"
          
          # Verify critical files exist
          if [ ! -f "deploy/miti/server.js" ]; then
            echo "âŒ server.js not found in standalone build!"
            exit 1
          fi
          
          if [ ! -f "deploy/miti/.next/BUILD_ID" ]; then
            echo "âŒ BUILD_ID not found! Standalone build may have failed."
            exit 1
          fi
          
          echo "âœ… Standalone package structure verified"
          
          # Copy deployment scripts
          cp ubuntu-setup.sh deploy/
          cp deploy.sh deploy/ || true
          
          # Create README for release
          cat > deploy/README.md << 'EOF'
          # MITI Release Package
          
          ## Quick Start (Ubuntu/Linux)
          
          1. Extract this package
          2. Run the setup script:
             ```bash
             chmod +x ubuntu-setup.sh
             ./ubuntu-setup.sh
             ```
          3. Access MITI at http://localhost:3000
          
          ## Manual Installation
          
          ### Requirements
          - Bun or Node.js 18+
          - ROS2 with rosbridge_server
          
          ### Run
          ```bash
          cd miti
          PORT=3000 HOSTNAME=0.0.0.0 bun server.js
          # or with Node.js:
          PORT=3000 HOSTNAME=0.0.0.0 node server.js
          ```
          
          ## Configuration
          
          Set environment variable:
          ```bash
          export NEXT_PUBLIC_ROSBRIDGE_URL=ws://your-robot-ip:9090
          ```
          
          ## More Info
          https://github.com/hiran-t/MITI
          EOF
          
          # Create tar.gz
          cd deploy
          tar -czf ../miti-standalone-${{ github.ref_name }}.tar.gz .
          cd ..
          
          echo "âœ… Standalone package created"
          ls -lh miti-standalone-*.tar.gz
          
          # Save as tar for release
          docker save miti:${{ github.ref_name }} | gzip > miti-docker-${{ github.ref_name }}.tar.gz
          
          echo "âœ… Docker image created"
          ls -lh miti-docker-*.tar.gz
      
      - name: Generate Release Notes
        id: changelog
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          ## ðŸš€ MITI ${{ github.ref_name }}
          
          ### ðŸ“¦ Download Options
          
          Choose the package that fits your needs:
          
          #### 1. Docker Image (Recommended) 
          - **File**: `miti-docker-${{ github.ref_name }}.tar.gz`
          - **Size**: ~500 MB
          - **Best for**: Easy deployment, isolated environment
          - **Usage**:
            ```bash
            # Load image
            docker load < miti-docker-${{ github.ref_name }}.tar.gz
            
            # Run container
            docker run -d -p 3000:3000 \
              -e NEXT_PUBLIC_ROSBRIDGE_URL=ws://localhost:9090 \
              --name miti miti:${{ github.ref_name }}
            ```
          
          #### 2. Standalone Build
          - **File**: `miti-standalone-${{ github.ref_name }}.tar.gz`
          - **Size**: ~100 MB
          - **Best for**: Direct deployment without Docker
          - **Usage**:
            ```bash
            # Extract
            tar -xzf miti-standalone-${{ github.ref_name }}.tar.gz
            
            # Run setup script
            chmod +x ubuntu-setup.sh
            ./ubuntu-setup.sh
            ```
          
          ### ðŸ“ What's Changed
          
          EOF
          
          # Add commit logs
          if git describe --tags --abbrev=0 HEAD^ 2>/dev/null; then
            git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"* %s (%h)" >> RELEASE_NOTES.md
          else
            git log --pretty=format:"* %s (%h)" >> RELEASE_NOTES.md
          fi
          
          cat >> RELEASE_NOTES.md << 'EOF'
          
          ### ðŸ”— Links
          - [Documentation](https://github.com/hiran-t/MITI/blob/main/README.md)
          - [API Reference](https://github.com/hiran-t/MITI/blob/main/docs/API.md)
          - [Deployment Guide](https://github.com/hiran-t/MITI/blob/main/docs/DEPLOYMENT.md)
          EOF
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            miti-standalone-${{ github.ref_name }}.tar.gz
            miti-docker-${{ github.ref_name }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  docker-hub:
    name: Push to Docker Hub (Optional)
    runs-on: ubuntu-latest
    needs: build-and-release
    if: false  # Set to true and configure secrets to enable
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: yourusername/miti
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
